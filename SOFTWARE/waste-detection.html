<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>AI Waste Detector</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.9.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8/dist/teachablemachine-image.min.js"></script>
  <style>
    body { background:linear-gradient(180deg,#f6f9ff,#eef6f2); }
    .card-ai { border-radius:12px; box-shadow:0 10px 30px rgba(16,24,40,0.08); }
    video { border-radius:8px; }
    .label-badge { font-size:1.1rem; font-weight:600; }
  </style>
</head>
<body class="p-4">
  <div class="d-flex justify-content-between mb-3">
    <h3>ðŸ¤– AI Waste Detector</h3>
    <div><a href="index.html" class="btn btn-outline-primary">Dashboard</a> <a href="map.html" class="btn btn-outline-success">Map</a></div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card card-ai p-3">
        <h6>Live Camera</h6>
        <div id="webcam-container" class="d-flex justify-content-center mb-2"></div>
        <div class="d-flex justify-content-center gap-2">
          <div class="text-center">
            <div class="label-badge" id="ai-label">Loading...</div>
            <div class="small text-muted" id="ai-confidence">--</div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card card-ai p-3">
        <h6>Info & Controls</h6>
        <p class="small text-muted">Model: <b>Dry / Wet</b> (Teachable Machine)</p>
        <div class="mb-2">
          <button id="pushToFirebase" class="btn btn-success btn-sm">Log Detection to Firebase</button>
          <button id="resetCounts" class="btn btn-outline-secondary btn-sm">Reset Stats</button>
        </div>
        <div class="mt-3">
          <h6>Session Stats</h6>
          <div>Dry: <span id="countDry">0</span></div>
          <div>Wet: <span id="countWet">0</span></div>
        </div>
      </div>
    </div>
  </div>

<script>
  // Teachable Machine model url
  const URL = "https://teachablemachine.withgoogle.com/models/9vPMhDShK/";
  let model, webcam;
  let sessionCounts = {Dry:0, Wet:0};

  async function init() {
    const modelURL = URL + "model.json";
    const metadataURL = URL + "metadata.json";
    model = await tmImage.load(modelURL, metadataURL);
    webcam = new tmImage.Webcam(360, 270, true);
    await webcam.setup();
    await webcam.play();
    const wc = document.getElementById('webcam-container');
    wc.appendChild(webcam.canvas);
    window.requestAnimationFrame(loop);
  }

  async function loop() {
    webcam.update();
    await predict();
    window.requestAnimationFrame(loop);
  }

  async function predict() {
    const preds = await model.predict(webcam.canvas);
    let best = preds.reduce((a,b)=> a.probability>b.probability?a:b);
    const label = best.className;
    const conf = (best.probability*100).toFixed(1) + '%';
    document.getElementById('ai-label').innerText = label;
    document.getElementById('ai-confidence').innerText = conf;

    // update session counts locally
    if (label === 'Dry' || label === 'dry' || label.toLowerCase().includes('dry')) sessionCounts.Dry++;
    if (label === 'Wet' || label === 'wet' || label.toLowerCase().includes('wet')) sessionCounts.Wet++;

    document.getElementById('countDry').innerText = sessionCounts.Dry;
    document.getElementById('countWet').innerText = sessionCounts.Wet;

    // optional: auto-log to firebase when confidence high
    if (best.probability > 0.85) {
      // short throttle by storing lastLoggedTime
      if (!window._lastLog || (Date.now() - window._lastLog) > 3000) {
        logPredictionToFirebase(label, best.probability);
        window._lastLog = Date.now();
      }
    }
  }

  async function logPredictionToFirebase(label, prob) {
    // push under bins/bin1/prediction (keeps last)
    const payload = { type: label, confidence: prob, ts: Date.now() };
    // write using REST via fetch to avoid adding firebase DB SDK here
    const base = "https://waste-detection-5b56e-default-rtdb.asia-southeast1.firebasedatabase.app";
    // write to bins/bin1/prediction
    fetch(base + '/bins/bin1/prediction.json', {
      method: 'PUT',
      body: JSON.stringify(payload),
      headers: { 'Content-Type': 'application/json' }
    }).then(r=>console.log('AI logged', r.status)).catch(e=>console.warn(e));
  }

  document.getElementById('pushToFirebase').addEventListener('click', ()=> {
    const l = document.getElementById('ai-label').innerText;
    const c = parseFloat(document.getElementById('ai-confidence').innerText) / 100 || 0;
    logPredictionToFirebase(l, c);
    alert('Logged current detection to Firebase');
  });

  document.getElementById('resetCounts').addEventListener('click', ()=> {
    sessionCounts = {Dry:0, Wet:0};
    document.getElementById('countDry').innerText = 0;
    document.getElementById('countWet').innerText = 0;
  });

  init();
</script>
</body>
</html>
